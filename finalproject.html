<!DOCTYPE html>
<html>
  <head>
      <meta charset="UTF-8">
      <title>Final Project</title>
      <script src="https://d3js.org/d3.v4.min.js"></script>

      <style>

      #svg {margin-left:auto; margin-right:auto; display:block;}
      #yearSlider {margin-left:auto; margin-right:auto; display:block;}

      </style>
  </head>

  <body id= "body">

    <svg id = "svg" align = "center"></svg>

    <div class="slidecontainer">
      <input type="range" min="1" max="100" value="50" class="slider" id="yearSlider">
    </div>

  <script>

    var width = 800
    var height = 600
    var padding = 50

    var drawCircles;

      var body = d3.select("body")
        .style("background-color", "lightgrey")
        .style("font-family", "Times New Roman")
        .attr("id", "body");

        var svg = d3.select("svg")
          .attr("width", width)
          .attr("height", height);



        //load CSV files
        d3.queue()
          .defer(d3.csv,"domesticConsumption.csv")
          .defer(d3.csv,"totalProduction.csv")
          .defer(d3.csv,"exports.csv")
          .awaitAll(function(error, dataArray) {
            console.log(dataArray);
            var domesticData = dataArray[0]
            var productionData = dataArray[1]
            var exportData = dataArray[2]

            //name all of the years columns
            var years = d3.range(1990, 2016, 1);
            //select the max value in all consumption data
            var domesticMax = d3.max(domesticData, function(d) {
              return d3.max(years.map(function(y) {
                return parseInt(d[y].replace(",", ""))*1000;
              }));
            });

            //select the max value in all production data
            var productionMax = d3.max(productionData, function(d) {
              return d3.max(years.map(function(y) {
                return parseInt(d[y].replace(",", ""))*1000;
              }));
            });

            //select the max value in all export data
            var exportMax = d3.max(exportData, function(d) {
              return d3.max(years.map(function(y) {
                return parseInt(d[y].replace(",", ""))*1000;
              }));
            });

            //set x-axis parameters
            var xScale = d3.scaleLog()
              .domain([1, domesticMax])
              .range([padding, width - padding]);
            //set y-axis parameters
            var yScale = d3.scaleLog()
              .domain([1, productionMax])
              .range([height - padding, padding]);

            var rScale = d3.scaleLinear()
              .domain([1, exportMax])
              .range([5,30])

              var xAxis = d3.axisBottom()
                .scale(xScale);

              var yAxis = d3.axisLeft()
                .scale(yScale);

                svg.append("g")
                .attr("transform", "translate("+(padding - 10)+", 0)")
                .call(yAxis);

                svg.append("g")
                .attr("transform", "translate(0, "+(height - padding + 10)+")")
                .call(xAxis);

            drawCircles = function(year) {


              var dataArray = [];
              domesticData.forEach(function(dom) {

                var obj = {};

                obj.country = dom.Country;
                obj.domestic = parseInt(dom[year].replace(",", ""))*1000;

                var prod = productionData.filter(function(p) {
                  return p.Country == obj.country;
                });
                obj.production = parseInt(prod[0][year].replace(",", ""))*1000;
                var exp = exportData.filter(function(p) {
                  return p.Country == obj.country;
                });
                obj.export = parseInt(exp[0][year].replace(",", ""))*1000;
                dataArray.push(obj);
              });
              console.log(dataArray);




              var circles = svg
                  .selectAll("circle")
                  .data(dataArray);



              //enter circles
              var circleEnter = circles.enter()
                .append("circle")
                .attr("cx", 0)
                .attr("cy", function(dataPoint, index) {
                  return 50;
                })
                .attr("r", function (d){
                    return 10;
                })
                .attr("fill","#4C4C4C")

              //update circles
              circles.merge(circleEnter)
                .transition().duration(3000)
                .attr("cx", function(dataPoint, index) {
                  return xScale(dataPoint.domestic || 1);
                })
                .attr("cy", function(dataPoint, index) {
                  //make yScale
                  return yScale(dataPoint.production || 1);
                })
                .attr("r", function(dataPoint, index) {
                  return rScale(dataPoint.export);
                })
                .attr("fill","#B1FCCF");


              //exit circles
              circles.exit()
                .transition()
                .duration(3000)
                .attr("r", 0)
                .remove();

            }

            drawCircles("2016");

            var slider = document.getElementById("yearSlider");
            var output = document.getElementById("demo");
            output.innerHTML = slider.value;


            slider.oninput = function() {
              output.innerHTML = this.value
              drawCircles(this.value);
            }

          });
  </script>
  </body>
  </html>
